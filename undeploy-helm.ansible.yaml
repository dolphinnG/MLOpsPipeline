---
- name: Uninstall Helm Charts from Kubernetes
  hosts: localhost
  # vars:
  vars_files:
    - vars.ansible.yaml
  tasks:
    - name: Ensure Helm is installed
      ansible.builtin.command: helm version
      register: helm_version
      failed_when: helm_version.rc != 0
      changed_when: false

    - name: Uninstall Helm release
      ansible.builtin.command: helm uninstall {{ item.release }}
      register: helm_uninstall
      changed_when: "'uninstalled' in helm_uninstall.stdout"
      loop: "{{ charts }}"
      loop_control:
        loop_var: item

    - name: Check for existing seldon deployments
      ansible.builtin.command: kubectl get deployments --all-namespaces -o json
      register: seldon_deployments
      changed_when: false

    - name: Check for existing seldon stateful sets
      ansible.builtin.command: kubectl get statefulsets --all-namespaces -o json
      register: seldon_statefulsets
      changed_when: false

    - name: Wait for seldon deployments and stateful sets to be deleted
      ansible.builtin.command: >
        kubectl get deployments,statefulsets --all-namespaces -o json
      register: seldon_resources
      until: >
        seldon_resources.stdout | from_json | json_query('items[?contains(metadata.name, `seldon`)]') | length == 0
      retries: 10
      delay: 10
      changed_when: false

    - name: Uninstall seldon-core-v2-setup Helm release
      ansible.builtin.command: helm uninstall seldon-core-v2-setup-hehe
      register: seldon_core_v2_setup_uninstall
      changed_when: "'uninstalled' in seldon_core_v2_setup_uninstall.stdout"

    - name: Delete all PersistentVolumeClaims
      ansible.builtin.command: kubectl delete pvc --all
      register: delete_pvc
      changed_when: "'deleted' in delete_pvc.stdout"

    - name: Delete all PersistentVolumes
      ansible.builtin.command: kubectl delete pv --all
      register: delete_pv
      changed_when: "'deleted' in delete_pv.stdout"
